#!/usr/bin/env php
<?php declare( strict_types=1 );

include $_composer_autoload_path ?? __DIR__.'/../vendor/autoload.php';

$communityPath=getcwd();
if( !$argv[ 1 ] ?? false ){
	$communityPath=$argv[ 1 ];
}

$finder=new \Symfony\Component\Finder\Finder();
// find all files in the current directory
$files=$finder->files()
	->in( $communityPath.'/api' )
	->in( $communityPath.'/admin' )
	->in( $communityPath.'/applications' )
	->in( $communityPath.'/system' )
	->name( '*.php' )
	->exclude( 'hooks' )
	->contains( 'class _' );

$aliasfile=$communityPath."/aliases.php";
file_put_contents( $aliasfile, '<?php '.PHP_EOL );

foreach( $files as $file ){
	// this shouldn't happen with IPS files, but ....
	$namespace='';
	if( preg_match( '#^namespace\s+(.+?);$#sm', $file->getContents(), $m ) ){
		$namespace=$m[ 1 ];
	}

	$classname=$file->getBasename( '.php' );
	$newClassname=$namespace.'\\'.$classname;
	$oldClassname=$namespace.'\\_'.$classname;

	$toAdd=<<<TOADD
class_alias('$oldClassname', '$newClassname', false);
TOADD;

	file_put_contents( $aliasfile, $toAdd.PHP_EOL, FILE_APPEND );
}

echo "generated ".$aliasfile . PHP_EOL;